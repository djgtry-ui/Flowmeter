<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMI Flowmeter - Final Sequential Logic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #0b1437; color: #d1d5db; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; }
        .card-custom { background: #111c44; border: 1px solid #1b254b; border-radius: 12px; }
        .btn-machine { background: #1a2244; border: 1px solid #2d3748; padding: 10px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; color: white; }
        .btn-machine.active { background: #3b82f6; border-color: #60a5fa; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .outlet-btn { padding: 8px 16px; border-radius: 6px; font-size: 11px; font-weight: 700; border: 1px solid #2d3748; background: #1a2244; color: #94a3b8; }
        .outlet-running { background: #facc15 !important; color: #000 !important; font-weight: 900; box-shadow: 0 0 12px #facc15; }
        .outlet-selected { border: 2px solid #3b82f6 !important; color: white; }
        .btn-ctrl { font-weight: 900; text-transform: uppercase; font-size: 10px; padding: 12px; border-radius: 10px; transition: 0.2s; color: white; }
        .btn-ctrl:active { transform: scale(0.95); opacity: 0.8; }
        .val-mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="p-6">

    <script>
        // SESSION & AUTO LOGOUT
        let userData = null;
        try { userData = JSON.parse(localStorage.getItem('user_data')); } catch(e) {}
        if (!localStorage.getItem('isLoggedIn')) { window.location.href = 'index.html'; }

        let idleTime = 0;
        document.addEventListener('mousedown', () => idleTime = 0);
        setInterval(() => {
            idleTime++;
            if (idleTime >= 60) { localStorage.clear(); window.location.href = 'index.html'; }
        }, 1000);
    </script>

    <div class="max-w-7xl mx-auto space-y-6">
        <header class="flex justify-between items-center border-b border-white/10 pb-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-network-wired text-white"></i></div>
                <div>
                    <h1 class="text-xl font-extrabold text-white">FLOWMETER <span class="text-blue-500">PRO 2026</span></h1>
                    <p id="opName" class="text-[10px] text-slate-500 font-bold uppercase italic">Operator: Loading...</p>
                </div>
            </div>
            <div class="flex gap-2 text-[10px] font-bold">
                <a href="status_flowmeter.html" class="bg-indigo-600 px-3 py-2 rounded text-white uppercase"><i class="fas fa-home"></i> Dashboard</a>
                <a href="history_flowmeter.html" class="bg-emerald-600 px-3 py-2 rounded text-white uppercase"><i class="fas fa-history"></i> History</a>
            </div>
        </header>

        <div id="machineList" class="flex flex-wrap gap-2"></div>

        <div class="card-custom p-6 grid grid-cols-2 md:grid-cols-6 gap-6 border-l-4 border-blue-500">
            <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase">No PO</p><div id="d-po" class="text-white text-sm font-bold">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase">No PBI</p><div id="d-pbi" class="text-white text-sm font-bold">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase">Material</p><div id="d-material" class="text-emerald-400 text-sm font-bold truncate">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase">PIC</p><div id="d-pic" class="text-white text-sm font-bold">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase">Stock</p><div id="d-stock" class="text-blue-400 text-sm font-bold">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black mb-1 uppercase">Machine</p><div id="d-mname" class="text-yellow-500 text-sm font-bold uppercase">--</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card-custom p-5">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-4 tracking-widest">Select Outlet:</p>
                    <div id="outletList" class="flex flex-wrap gap-3"></div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="card-custom p-6 text-center border-t-2 border-blue-500/20">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-2">Target (Kg)</p>
                        <input type="number" id="i-target" class="bg-transparent text-3xl font-black text-white val-mono text-center w-full focus:outline-none" onchange="control('UPDATE_TARGET', this.value)">
                    </div>
                    <div class="card-custom p-6 text-center bg-emerald-500/5 border-t-2 border-emerald-500/20">
                        <p class="text-[10px] text-emerald-500/50 font-bold uppercase mb-2">Actual (Kg)</p>
                        <div id="d-aktual" class="text-3xl font-black text-emerald-500 val-mono">0.00</div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card-custom p-6 space-y-4 text-xs border-r-4 border-blue-500">
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-white/5 pb-2">Technical Info</p>
                    <div class="flex justify-between"><span>Jalur</span><span id="d-route" class="font-bold text-blue-400">--</span></div>
                    <div class="flex justify-between"><span>System ID</span><span id="d-sysid" class="font-mono text-slate-300">--</span></div>
                    <div class="flex justify-between text-[10px]"><span>Status</span><span id="d-status-msg" class="text-yellow-500 italic font-bold">READY</span></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="control('START')" class="btn-ctrl bg-emerald-600 hover:bg-emerald-500 h-20 shadow-lg"><i class="fas fa-play mb-2 text-xl"></i> START</button>
                    <button onclick="control('STOP')" class="btn-ctrl bg-amber-500 hover:bg-amber-400 h-20 shadow-lg"><i class="fas fa-stop mb-2 text-xl"></i> STOP</button>
                    <button onclick="control('RESET')" class="btn-ctrl bg-rose-600 hover:bg-rose-500 h-20 shadow-lg"><i class="fas fa-undo mb-2 text-xl"></i> RESET</button>
                    <button onclick="control('MASTER_RESET')" class="btn-ctrl bg-red-950 hover:bg-red-900 h-20 text-[8px] shadow-lg"><i class="fas fa-power-off mb-2 text-xl text-red-500"></i> MASTER RESET</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SHEET_ID = '141uuIOYNPmIYjI6OvCHRbMOOXrWtfFVfAisAis0zL-0';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=result_flowmeter`;
        const PROXY_URL = "proxy_propan.php"; 

        let activeMachineID = '1'; 
        let userSelectedIdx = 1; 

        if (userData) document.getElementById('opName').innerText = "Operator: " + userData.username.toUpperCase();

        // Helper function for delay
        const sleep = ms => new Promise(res => setTimeout(res, ms));

        async function sendToProxy(data) {
            return fetch(PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        async function control(type, extraVal = null) {
            const statusLabel = document.getElementById('d-status-msg');
            const cmdMap = { 'START':'Start', 'STOP':'Stop', 'RESET':'Reset', 'MASTER_RESET':'MstrReset' };
            
            if (type === 'UPDATE_TARGET') {
                await sendToProxy({ id_mesin: activeMachineID, [`Outlet_${userSelectedIdx}_Target`]: extraVal });
                return;
            }

            const skey = `Outlet_${userSelectedIdx}_Switch`;
            const ckey = `Outlet_${userSelectedIdx}_${cmdMap[type]}`;
            const pulseTime = (type === 'MASTER_RESET') ? 3000 : 1500;

            try {
                statusLabel.innerText = "SWITCHING ON...";
                // 1. Kirim Switch 1
                await sendToProxy({ id_mesin: activeMachineID, [skey]: 1 });
                await sleep(500);

                statusLabel.innerText = type + " ACTIVE...";
                // 2. Kirim Command 1
                await sendToProxy({ id_mesin: activeMachineID, [ckey]: 1 });
                await sleep(pulseTime);

                statusLabel.innerText = "RELEASING...";
                // 3. Kirim Command 0
                await sendToProxy({ id_mesin: activeMachineID, [ckey]: 0 });
                await sleep(400);

                statusLabel.innerText = "CLOSING SWITCH...";
                // 4. Kirim Switch 0
                await sendToProxy({ id_mesin: activeMachineID, [skey]: 0 });
                
                statusLabel.innerText = "DONE";
                setTimeout(() => statusLabel.innerText = "READY", 2000);
                setTimeout(fetchData, 500);

            } catch (e) {
                statusLabel.innerText = "ERROR";
                console.error(e);
            }
        }

        async function fetchData() {
            try {
                const res = await fetch(`${CSV_URL}&t=${Date.now()}`);
                const text = await res.text();
                const rows = text.split(/\r?\n/).filter(r => r.trim() !== "").map(row => {
                    return row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
                });
                const data = rows.find(r => r[1] === activeMachineID);
                if (data) renderUI(data);
            } catch (e) { console.log("Fetch Error"); }
        }

        function renderUI(data) {
            document.getElementById('d-po').innerText = data[6] || "--";
            document.getElementById('d-pbi').innerText = data[7] || "--";
            document.getElementById('d-material').innerText = data[9] || "--";
            document.getElementById('d-pic').innerText = data[10] || "--";
            document.getElementById('d-stock').innerText = data[11] || "0";
            document.getElementById('d-mname').innerText = data[5] || "--";

            const outletAktifPLC = parseInt(data[4]) || 0;
            const outList = document.getElementById('outletList');
            outList.innerHTML = '';

            for (let i = 1; i <= 11; i++) {
                const baseIdx = 15 + ((i - 1) * 9);
                const name = data[baseIdx];
                if (name && name !== "0" && name !== "...") {
                    const btn = document.createElement('button');
                    btn.className = `outlet-btn ${i === outletAktifPLC ? 'outlet-running' : ''} ${i === userSelectedIdx ? 'outlet-selected' : ''}`;
                    btn.innerText = name;
                    btn.onclick = () => { userSelectedIdx = i; fetchData(); };
                    outList.appendChild(btn);
                }
            }

            const selBaseIdx = 15 + ((userSelectedIdx - 1) * 9);
            const targetVal = parseFloat(data[selBaseIdx + 1]?.replace(',', '.') || 0);
            const aktual = parseFloat(data[12]?.replace(',', '.') || 0);
            if (document.activeElement !== document.getElementById('i-target')) {
                document.getElementById('i-target').value = targetVal.toFixed(2);
            }
            document.getElementById('d-aktual').innerText = aktual.toFixed(2);
            document.getElementById('d-route').innerText = data[selBaseIdx] || "--";
            document.getElementById('d-sysid').innerText = userSelectedIdx;
        }

        // INIT MACHINES
        const machines = [{id:'1', name:'TH SMT'}, {id:'2', name:'TH P-01'}, {id:'3', name:'TH V-09'}, {id:'4', name:'TH P-05'}, {id:'5', name:'TH WF'}];
        machines.forEach(m => {
            const btn = document.createElement('button');
            btn.className = `btn-machine ${m.id === activeMachineID ? 'active' : ''}`;
            btn.innerText = m.name;
            btn.onclick = () => { 
                activeMachineID = m.id; 
                document.querySelectorAll('.btn-machine').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); 
                fetchData(); 
            };
            document.getElementById('machineList').appendChild(btn);
        });

        fetchData();
        setInterval(fetchData, 4000);
    </script>
</body>
</html>
