<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HMI Flowmeter Pro - Momentary Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@700&family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        body { background: #0b1437; color: #d1d5db; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; }
        .card-custom { background: #111c44; border: 1px solid #1b254b; border-radius: 12px; }
        .btn-machine { background: #1a2244; border: 1px solid #2d3748; padding: 10px; border-radius: 8px; font-size: 11px; font-weight: 800; cursor: pointer; color: white; }
        .btn-machine.active { background: #3b82f6; border-color: #60a5fa; box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
        .outlet-btn { padding: 8px 16px; border-radius: 6px; font-size: 11px; font-weight: 700; border: 1px solid #2d3748; background: #1a2244; color: #94a3b8; }
        .outlet-running { background: #facc15 !important; color: #000 !important; font-weight: 900; box-shadow: 0 0 12px #facc15; }
        .outlet-selected { border: 2px solid #3b82f6 !important; color: white; }
        .btn-ctrl { font-weight: 900; text-transform: uppercase; font-size: 10px; padding: 12px; border-radius: 10px; transition: 0.2s; color: white; }
        .btn-ctrl:active { transform: scale(0.95); opacity: 0.8; }
        .val-mono { font-family: 'JetBrains Mono', monospace; }
    </style>
</head>
<body class="p-6">

    <script>
        let userData = null;
        try { userData = JSON.parse(localStorage.getItem('user_data')); } catch(e) {}

        if (!localStorage.getItem('isLoggedIn')) { window.location.href = 'index.html'; }

        let idleTime = 0;
        function resetTimer() { idleTime = 0; }
        document.addEventListener('touchstart', resetTimer);
        document.addEventListener('mousemove', resetTimer);
        document.addEventListener('mousedown', resetTimer);
        document.addEventListener('keypress', resetTimer);
        document.addEventListener('scroll', resetTimer);

        setInterval(function() {
            idleTime++;
            if (idleTime >= 60) { 
                localStorage.clear();
                window.location.href = 'index.html';
            }
        }, 1000);
    </script>

    <div class="max-w-7xl mx-auto space-y-6">
        <header class="flex justify-between items-center border-b border-white/10 pb-4">
            <div class="flex items-center gap-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-network-wired text-white"></i></div>
                <div>
                    <h1 class="text-xl font-extrabold text-white uppercase">Flowmeter <span class="text-blue-500">Control</span></h1>
                    <p id="opName" class="text-[10px] text-slate-500 font-bold tracking-widest uppercase italic">Operator: Loading...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="status_flowmeter.html" class="bg-blue-600 px-3 py-2 rounded text-[10px] font-bold text-white transition flex items-center gap-2 uppercase"><i class="fas fa-home"></i> Home</a>
                <a href="history_flowmeter.html" class="bg-emerald-600 px-3 py-2 rounded text-[10px] font-bold text-white transition flex items-center gap-2 uppercase"><i class="fas fa-history"></i> History</a>
            </div>
        </header>

        <div id="machineList" class="flex flex-wrap gap-2"></div>

        <div class="card-custom p-6 grid grid-cols-2 md:grid-cols-6 gap-6 border-l-4 border-blue-500 shadow-xl">
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">No PO</p><div id="d-po" class="font-bold text-white text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">No PBI</p><div id="d-pbi" class="font-bold text-white text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">Material</p><div id="d-material" class="font-bold text-emerald-400 text-sm truncate">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">PIC</p><div id="d-pic" class="font-bold text-white text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">Stock</p><div id="d-stock" class="font-bold text-blue-400 text-sm">--</div></div>
            <div><p class="text-[10px] text-slate-500 font-black uppercase mb-1">Machine</p><div id="d-mname" class="font-bold text-yellow-500 uppercase text-sm">--</div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 space-y-6">
                <div class="card-custom p-5">
                    <p class="text-[10px] text-slate-500 font-black uppercase mb-4 tracking-widest">Select Outlet:</p>
                    <div id="outletList" class="flex flex-wrap gap-3"></div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="card-custom p-6 text-center border-t-2 border-blue-500/20">
                        <p class="text-[10px] text-slate-500 font-bold uppercase mb-2">Target (Kg)</p>
                        <input type="number" id="i-target" class="bg-transparent text-3xl font-black text-white val-mono text-center w-full focus:outline-none" value="0.00" onchange="control('UPDATE_TARGET', this.value)">
                    </div>
                    <div class="card-custom p-6 text-center bg-emerald-500/5 border-t-2 border-emerald-500/20">
                        <p class="text-[10px] text-emerald-500/50 font-bold uppercase mb-2">Actual (Kg)</p>
                        <div id="d-aktual" class="text-3xl font-black text-emerald-500 val-mono">0.00</div>
                    </div>
                </div>

                <div class="card-custom p-5">
                    <div class="flex justify-between text-[10px] font-black mb-2 uppercase"><span>Filling Progress</span><span id="d-progress" class="text-emerald-500">0%</span></div>
                    <div class="w-full bg-slate-900 rounded-full h-3 p-[2px]">
                        <div id="progress-bar" class="bg-emerald-500 h-full rounded-full transition-all duration-700 shadow-[0_0_10px_#10b981]" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="card-custom p-6 space-y-4 text-xs border-r-4 border-blue-500">
                    <p class="text-[10px] text-slate-500 font-black uppercase tracking-widest border-b border-white/5 pb-2">Technical Info</p>
                    <div class="flex justify-between"><span>Jalur</span><span id="d-route" class="font-bold text-blue-400">--</span></div>
                    <div class="flex justify-between"><span>System ID</span><span id="d-sysid" class="font-mono text-slate-300">--</span></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-start" onclick="control('START')" class="btn-ctrl bg-emerald-600 hover:bg-emerald-500 h-20 shadow-lg"><i class="fas fa-play mb-2 text-xl"></i> START</button>
                    <button id="btn-stop" onclick="control('STOP')" class="btn-ctrl bg-amber-500 hover:bg-amber-400 h-20 shadow-lg"><i class="fas fa-stop mb-2 text-xl"></i> STOP</button>
                    <button id="btn-reset" onclick="control('RESET')" class="btn-ctrl bg-rose-600 hover:bg-rose-500 h-20 shadow-lg"><i class="fas fa-undo mb-2 text-xl"></i> RESET</button>
                    <button id="btn-master" onclick="control('MASTER_RESET')" class="btn-ctrl bg-red-950 hover:bg-red-900 h-20 text-[8px] shadow-lg"><i class="fas fa-power-off mb-2 text-xl text-red-500"></i> MASTER RESET</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. INITIALIZATION ---
        const SHEET_ID = '141uuIOYNPmIYjI6OvCHRbMOOXrWtfFVfAisAis0zL-0';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&sheet=result_flowmeter`;
        const PROXY_URL = "proxy_propan.php"; 

        let activeMachineID = '1'; 
        let userSelectedIdx = 1; 

        if (userData) document.getElementById('opName').innerText = "Operator: " + userData.username.toUpperCase();

        // --- 2. DATA FETCHING ---
        async function fetchData() {
            try {
                const res = await fetch(`${CSV_URL}&t=${Date.now()}`);
                const text = await res.text();
                const rows = text.split(/\r?\n/).filter(r => r.trim() !== "").map(row => {
                    return row.split(/,(?=(?:[^"]*"[^"]*")*[^"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
                });
                const data = rows.find(r => r[1] === activeMachineID);
                if (data) renderUI(data);
            } catch (e) { console.log("Sync error"); }
        }

        function renderUI(data) {
            document.getElementById('d-po').innerText = data[6] || "--";
            document.getElementById('d-pbi').innerText = data[7] || "--";
            document.getElementById('d-material').innerText = data[9] || "--";
            document.getElementById('d-pic').innerText = data[10] || "--";
            document.getElementById('d-stock').innerText = data[11] || "0";
            document.getElementById('d-mname').innerText = data[5] || "--";

            const outletAktifPLC = parseInt(data[4]) || 0;
            const outList = document.getElementById('outletList');
            outList.innerHTML = '';

            for (let i = 1; i <= 11; i++) {
                const baseIdx = 15 + ((i - 1) * 9);
                const name = data[baseIdx];
                if (name && name !== "0" && name !== "...") {
                    const btn = document.createElement('button');
                    btn.className = `outlet-btn ${i === outletAktifPLC ? 'outlet-running' : ''} ${i === userSelectedIdx ? 'outlet-selected' : ''}`;
                    btn.innerText = name;
                    btn.onclick = () => { userSelectedIdx = i; fetchData(); };
                    outList.appendChild(btn);
                }
            }

            const selBaseIdx = 15 + ((userSelectedIdx - 1) * 9);
            const targetVal = parseFloat(data[selBaseIdx + 1]?.replace(',', '.') || 0);
            const aktual = parseFloat(data[12]?.replace(',', '.') || 0);
            const progress = targetVal > 0 ? Math.min((aktual/targetVal)*100, 100) : 0;

            if (document.activeElement !== document.getElementById('i-target')) {
                document.getElementById('i-target').value = targetVal.toFixed(2);
            }
            document.getElementById('d-aktual').innerText = aktual.toFixed(2);
            document.getElementById('d-route').innerText = data[selBaseIdx] || "--";
            document.getElementById('d-sysid').innerText = userSelectedIdx;
            document.getElementById('d-progress').innerText = progress.toFixed(1) + "%";
            document.getElementById('progress-bar').style.width = progress + "%";
        }

        // --- 3. MOMENTARY CONTROL LOGIC (KIRIM 1 -> JEDA -> KIRIM 0) ---
        async function control(type, extraVal = null) {
            let payloadOn = { id_mesin: activeMachineID };
            let payloadOff = { id_mesin: activeMachineID };
            
            // Bypass untuk Update Target (Tidak momentary)
            if (type === 'UPDATE_TARGET') {
                payloadOn[`Outlet_${userSelectedIdx}_Target`] = extraVal;
                await sendToProxy(payloadOn);
                return;
            }

            // Set Sinyal Switch (Wajib 1 saat tekan)
            payloadOn[`Outlet_${userSelectedIdx}_Switch`] = 1;
            payloadOff[`Outlet_${userSelectedIdx}_Switch`] = 0;

            // Mapping Tombol
            const cmdMap = {
                'START': 'Start',
                'STOP': 'Stop',
                'RESET': 'Reset',
                'MASTER_RESET': 'MstrReset'
            };

            const cmdKey = `Outlet_${userSelectedIdx}_${cmdMap[type]}`;
            payloadOn[cmdKey] = 1;
            payloadOff[cmdKey] = 0;

            try {
                // KIRIM SINYAL HIGH (1)
                console.log("Momentary HIGH:", payloadOn);
                const res = await sendToProxy(payloadOn);
                
                if (res.ok) {
                    // JEDA 1 DETIK LALU KIRIM SINYAL LOW (0)
                    setTimeout(async () => {
                        console.log("Momentary LOW (Reset):", payloadOff);
                        await sendToProxy(payloadOff);
                        setTimeout(fetchData, 500);
                    }, 1000);
                } else {
                    alert("Gagal mengirim perintah ke server!");
                }
            } catch (e) {
                alert("Koneksi ke proxy gagal!");
            }
        }

        async function sendToProxy(data) {
            return fetch(PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // --- 4. RENDER MACHINES ---
        const machines = [
            {id:'1', name:'TH SMT'}, {id:'2', name:'TH P-01'}, 
            {id:'3', name:'TH V-09'}, {id:'4', name:'TH P-05'}, {id:'5', name:'TH WF'}
        ];
        
        machines.forEach(m => {
            const btn = document.createElement('button');
            btn.className = `btn-machine ${m.id === activeMachineID ? 'active' : ''}`;
            btn.innerText = m.name;
            btn.onclick = () => { 
                activeMachineID = m.id; 
                document.querySelectorAll('.btn-machine').forEach(b => b.classList.remove('active')); 
                btn.classList.add('active'); 
                fetchData(); 
            };
            document.getElementById('machineList').appendChild(btn);
        });

        fetchData();
        setInterval(fetchData, 3000);
    </script>
</body>
</html>
